<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/TRCKNG-SSTM/manifest.json">
  <link rel="apple-touch-icon" href="/TRCKNG-SSTM/icons/icon-192.png">
  <title>TRCKNG SSTM</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000000;
      color: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));
      background: #000000;
      color: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .container {
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .header {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 12px 16px;
      gap: 16px;
      position: relative;
    }

    .header-left {
      position: absolute;
      left: 16px;
      top: 12px;
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: flex-start;
      text-align: left;
    }

    .header-center {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: center;
      text-align: center;
    }

    .header-right {
      position: absolute;
      right: 16px;
      top: 12px;
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      gap: 2px;
      align-items: flex-end;
      text-align: right;
    }

    .header-week {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.12em;
      line-height: 1;
    }

    .header-weekdate {
      font-size: 9px;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      line-height: 1.2;
    }

    .header-title {
      font-size: 9px;
      letter-spacing: 0.12em;
      color: rgba(255, 255, 255, 0.7);
      text-transform: uppercase;
      white-space: nowrap;
      line-height: 1.2;
    }

    .header-time {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.08em;
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }

    .header-daydate {
      font-size: 9px;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
      line-height: 1.2;
    }
    .controls {
      display: flex;
      gap: 1px;
      width: 100%;
    }
    .btn-control {
      flex: 1;
      border: none;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      background: #000000;
      color: rgba(255, 255, 255, 0.7);
      padding: 8px 6px;
      cursor: pointer;
      font-size: 8px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: all 100ms ease-out;
      -webkit-tap-highlight-color: transparent;
      min-height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .btn-control:last-child {
      border-right: none;
    }
    .btn-control:hover {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.9);
    }
    .btn-control:active {
      background: rgba(255, 255, 255, 0.12);
    }
    .btn-control.active {
      background: rgba(255, 79, 106, 0.3);
      color: #ff4f6a;
      border-color: rgba(255, 79, 106, 0.5);
    }

    /* ===== PINS ===== */
    .pins {
      display: flex;
      gap: 1px;
      width: 100%;
    }

    .pin {
      flex: 1;
      border: none;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      background: #000000;
      color: rgba(255, 255, 255, 0.5);
      padding: 8px 6px;
      cursor: pointer;
      font-size: 8px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      transition: all 100ms ease-out;
      -webkit-tap-highlight-color: transparent;
      min-height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pin:last-child {
      border-right: none;
    }

    .pin:hover {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.8);
    }

    .pin:active {
      background: rgba(255, 255, 255, 0.12);
    }

    .pin.active {
      background: rgba(255, 140, 66, 0.2);
      color: #ff8c42;
      border-right-color: rgba(255, 140, 66, 0.5);
    }

    /* ===== SPLASH & INFO ===== */
    .splash {
      position: fixed;
      inset: 0;
      background: #000000;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      flex-direction: column;
      gap: 24px;
      padding: 20px;
    }

    .splash.hidden {
      display: none;
    }

    .splash-logo {
      font-size: 64px;
      font-weight: 300;
      letter-spacing: 0.12em;
      text-align: center;
      margin-bottom: 20px;
    }

    .splash-version {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
    }

    .splash-btn {
      border: 2px solid #ff8c42;
      background: #ff8c42;
      color: #000000;
      padding: 12px 24px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 100ms ease-out;
      font-weight: 500;
    }

    .splash-btn:hover {
      background: rgba(255, 140, 66, 0.9);
    }

    /* Info modal */
    .info-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 16px;
    }

    .info-modal.visible {
      display: flex;
    }

    .info-modal-content {
      background: #000000;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 28px 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .info-title {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      margin-bottom: 8px;
    }

    .info-section {
      margin-bottom: 12px;
    }

    .info-section-title {
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #ff8c42;
      margin-bottom: 8px;
    }

    .info-text {
      font-size: 12px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.8);
    }

    .info-button {
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: #000000;
      color: rgba(255, 255, 255, 0.7);
      padding: 12px 16px;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 100ms ease-out;
      margin-top: 8px;
    }

    .info-button:hover {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.9);
    }

    /* Пульсирующая кнопка ? при первом открытии */
    @keyframes pulse {
      0% {
        background: rgba(255, 140, 66, 0.3);
      }
      50% {
        background: rgba(255, 140, 66, 0.8);
      }
      100% {
        background: rgba(255, 140, 66, 0.3);
      }
    }

    #btnInfo.pulse {
      animation: pulse 1.5s ease-in-out infinite;
      color: #ff8c42;
      border-color: #ff8c42;
    }

    #btnInfo.pulse:hover {
      animation: none;
    }
    .version {
      font-size: 9px;
      letter-spacing: 0.12em;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 6px;
      text-transform: uppercase;
      line-height: 1.3;
    }
    .week-display {
      font-size: 28px;
      font-weight: 300;
      letter-spacing: 0.12em;
      margin-bottom: 4px;
    }
    .date-display {
      font-size: 10px;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.6);
    }
    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    .btn-habit {
      border: none;
      background: #000000;
      color: #ffffff;
      padding: 0;
      cursor: pointer;
      font-size: 13px;
      letter-spacing: 0.06em;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 100ms ease-out;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      position: relative;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
      -webkit-appearance: none;
      appearance: none;
      aspect-ratio: 1;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    .btn-habit::-moz-focus-inner {
      border: 0;
    }

    /* Неактивные ячейки */
    .btn-habit.inactive {
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: #000000;
      opacity: 1;
    }

    .btn-habit.inactive::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        linear-gradient(45deg, transparent calc(50% - 1px), rgba(255, 255, 255, 0.2) calc(50% - 1px), rgba(255, 255, 255, 0.2) calc(50% + 1px), transparent calc(50% + 1px)),
        linear-gradient(-45deg, transparent calc(50% - 1px), rgba(255, 255, 255, 0.2) calc(50% - 1px), rgba(255, 255, 255, 0.2) calc(50% + 1px), transparent calc(50% + 1px));
      pointer-events: none;
    }
    .btn-habit::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--btn-color, transparent);
      opacity: 0;
      transition: opacity 600ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
      pointer-events: none;
      z-index: 0;
    }
    /* Hover state — лёгкий серый */
    .btn-habit:hover::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.08);
      pointer-events: none;
      z-index: 1;
    }
    .btn-habit > * {
      position: relative;
      z-index: 2;
    }
    /* Состояние при клике — быстрая атака + задержка + плавное затухание */
    .btn-habit.animating::before {
      opacity: var(--btn-intensity-attack, 0);
      animation: colorAttackFade 800ms ease-out forwards;
    }
    @keyframes colorAttackFade {
      0% {
        opacity: 0.85;
      }
      20% {
        opacity: 0.85;
      }
      100% {
        opacity: 0;
      }
    }
    .btn-label {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.8;
    }
    .btn-count {
      font-size: 28px;
      font-variant-numeric: tabular-nums;
      font-weight: 300;
      opacity: 0.7;
    }

    .stats {
      padding: 0;
      overflow: hidden;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.8);
    }

    .stats-table thead {
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .stats-table th {
      padding: 10px 8px;
      text-align: left;
      font-weight: 400;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.6);
      font-size: 10px;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stats-table th:last-child {
      border-right: none;
    }

    .stats-table tbody tr {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stats-table tbody tr:last-child {
      border-bottom: none;
    }

    .stats-table td {
      padding: 10px 8px;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .stats-table td:first-child {
      text-align: left;
      font-size: 10px;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.5);
      font-weight: 400;
      text-transform: uppercase;
    }

    .stats-table td:last-child {
      border-right: none;
    }

    .stats-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    /* Highlight при наведении на ячейку */
    .stats-table tbody tr:hover td,
    .stats-table thead tr:hover th {
      background: rgba(255, 255, 255, 0.08);
    }

    .stats-table tbody tr:hover td:first-child,
    .stats-table thead tr:hover th:first-child {
      background: rgba(53, 242, 163, 0.15);
      color: #35f2a3;
    }

    /* Highlight столбца при наведении */
    .stats-table tbody tr td:hover,
    .stats-table thead th:hover {
      background: rgba(53, 242, 163, 0.2);
      color: #35f2a3;
      font-weight: 500;
    }

    /* ===== EDIT MODAL ===== */
    .edit-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .edit-modal.visible {
      display: flex;
    }
    .edit-modal-content {
      background: #000000;
      border: 1px solid rgba(255, 255, 255, 0.3);
      max-height: 90vh;
      overflow-y: auto;
      max-width: 500px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));
    }
    .edit-modal-header {
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.4);
      padding: 28px 20px;
    }
    .edit-modal-title {
      font-size: 10px;
      letter-spacing: 0.12em;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 16px;
      text-transform: uppercase;
    }
    .edit-modal-version {
      font-size: 48px;
      font-weight: 300;
      letter-spacing: 0.12em;
      text-align: center;
    }
    .edit-items-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.3);
    }
    .edit-item {
      background: #000000;
      border: none;
      padding: 20px 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      min-height: 100px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .edit-item:hover {
      background: rgba(255, 255, 255, 0.04);
    }
    .edit-item-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(255, 255, 255, 0.5);
    }
    .edit-item-name {
      font-size: 13px;
      color: #ffffff;
      font-weight: 400;
      text-align: center;
      word-break: break-word;
    }
    .edit-modal-buttons {
      display: flex;
      gap: 1px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .edit-modal-btn {
      flex: 1;
      border: none;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      background: #000000;
      color: rgba(255, 255, 255, 0.7);
      padding: 12px 8px;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 100ms ease-out;
      -webkit-tap-highlight-color: transparent;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .edit-modal-btn:last-child {
      border-right: none;
    }
    .edit-modal-btn:hover {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.9);
    }
    .edit-modal-btn:active {
      background: rgba(255, 255, 255, 0.12);
    }
    .edit-modal-btn.primary {
      border-color: #35f2a3;
      background: #35f2a3;
      color: #000000;
    }
    .edit-modal-btn.primary:hover {
      background: #4df7b5;
    }

    /* Modal для редактирования одной ячейки */
    .edit-cell-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 101;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .edit-cell-modal.visible {
      display: flex;
    }
    .edit-cell-modal-content {
      background: #000000;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 24px;
      max-width: 350px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .edit-cell-modal-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
    }
    .edit-cell-modal-input {
      background: #050607;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #ffffff;
      padding: 12px 12px;
      font-size: 14px;
      font-family: inherit;
      border-radius: 0;
      text-align: center;
    }
    .edit-cell-modal-input:focus {
      outline: none;
      border-color: #35f2a3;
      box-shadow: 0 0 0 1px rgba(53, 242, 163, 0.2);
    }
    .edit-cell-modal-buttons {
      display: flex;
      gap: 1px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .edit-cell-modal-btn {
      flex: 1;
      border: none;
      border-right: 1px solid rgba(255, 255, 255, 0.3);
      background: #050607;
      color: rgba(255, 255, 255, 0.7);
      padding: 10px 8px;
      font-size: 10px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 100ms ease-out;
      -webkit-tap-highlight-color: transparent;
    }
    .edit-cell-modal-btn:last-child {
      border-right: none;
    }
    .edit-cell-modal-btn:hover {
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.9);
    }
    .edit-cell-modal-btn.primary {
      border-color: #35f2a3;
      background: #35f2a3;
      color: #000000;
    }
    .edit-cell-modal-btn.primary:hover {
      background: #4df7b5;
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <div class="header-left">
        <div class="header-title">TRCKNG SSTM · v0.21</div>
      </div>
      <div class="header-center">
        <div class="header-week" id="weekDisplay"></div>
        <div class="header-weekdate" id="dateDisplay"></div>
      </div>
      <div class="header-right">
        <div class="header-time" id="headerTime">--:--</div>
        <div class="header-daydate" id="headerDayDate"></div>
      </div>
    </div>

    <!-- PINS / PAGES -->
    <div class="pins">
      <button class="pin active" data-pin="0" id="pin0">PIN 01</button>
      <button class="pin" data-pin="1" id="pin1">PIN 02</button>
      <button class="pin" data-pin="2" id="pin2">PIN 03</button>
    </div>

    <div class="controls">
      <button class="btn-control" id="btnCopyPrev">COPY</button>
      <button class="btn-control" id="btnExport">EXPORT</button>
      <button class="btn-control" id="btnImport">IMPORT</button>
      <button class="btn-control" id="btnReset">RESET</button>
      <button class="btn-control" id="btnInfo">?</button>
    </div>

    <div class="controls">
      <button class="btn-control" id="btnDecrease">DECREASE</button>
      <button class="btn-control" id="btnEdit">EDIT</button>
    </div>

    <div class="buttons-grid" id="habitsGrid"></div>

    <div class="stats" id="stats"></div>
  </div>

  <input type="file" id="fileInput" accept=".json,.txt" style="display:none">

  <!-- SPLASH SCREEN -->
  <div class="splash" id="splash">
    <div class="splash-logo">TRCKNG SSTM</div>
    <div class="splash-version">v0.1 · Weekly Habit Tracker</div>
    <button class="splash-btn" id="btnStartApp">START</button>
  </div>

  <!-- INFO MODAL -->
  <div class="info-modal" id="infoModal">
    <div class="info-modal-content">
      <div class="info-title">TRCKNG SSTM · v0.21</div>
      
      <div class="info-section">
        <div class="info-section-title">What is this?</div>
        <div class="info-text">
          A minimal weekly habit tracker. Define your own habits, track them across 3 independent pages (pins), and keep everything stored locally on your device. No cloud, no accounts, just you and your data.
        </div>
      </div>

      <div class="info-section">
        <div class="info-section-title">How it works</div>
        <div class="info-text">
          <strong>9 cells:</strong> Each can be customized or left empty<br>
          <strong>3 pins:</strong> Independent tracking pages with separate data<br>
          <strong>Weekly counter:</strong> Auto-counts by ISO week standard<br>
          <strong>Color gradient:</strong> Visual feedback on each tap
        </div>
      </div>

      <div class="info-section">
        <div class="info-section-title">Toolbar</div>
        <div class="info-text">
          <strong>COPY:</strong> Copy previous week to clipboard<br>
          <strong>EXPORT:</strong> Download all data as JSON<br>
          <strong>IMPORT:</strong> Restore from JSON backup<br>
          <strong>DECREASE:</strong> Toggle subtract mode<br>
          <strong>EDIT:</strong> Customize cell names<br>
          <strong>?:</strong> This help menu
        </div>
      </div>

      <div class="info-section">
        <div class="info-section-title">Customization</div>
        <div class="info-text">
          Click <strong>EDIT</strong> to rename any cell. Empty name = inactive cell (hidden from view). Each pin remembers its own configuration.
        </div>
      </div>

      <div class="info-section">
        <div class="info-section-title">Install as App</div>
        <div class="info-text">
          <strong>iOS:</strong> Safari → Share → Add to Home Screen<br>
          <strong>Android:</strong> Chrome → Menu → Install app<br>
          <strong>Desktop:</strong> Use as PWA or bookmark
        </div>
      </div>

      <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <div style="font-size: 9px; color: rgba(255, 255, 255, 0.6); text-align: center; margin-bottom: 12px; line-height: 1.4;">
          TRCKNG SSTM · Weekly Habit Tracker<br>
          dev by Grisha Tsvetkov
        </div>
        <div style="display: flex; gap: 6px;">
          <a href="https://buymeacoffee.com/comp1mov" target="_blank" style="flex: 1;">
            <button class="info-button" style="margin: 0; width: 100%;">Support me</button>
          </a>
          <button class="info-button" id="btnInfoClose" style="margin: 0; flex: 1;">CLOSE</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN EDIT MODAL -->
  <div class="edit-modal" id="editModal">
    <div class="edit-modal-content">
      <div class="edit-modal-header">
        <div class="edit-modal-title">TRCKNG SSTM · v0.21<br>dev by Grisha Tsvetkov</div>
        <div class="edit-modal-version">EDIT</div>
      </div>

      <div class="edit-items-grid" id="editItemsContainer"></div>

      <div style="font-size: 11px; color: rgba(255, 255, 255, 0.5); margin: 12px 0; line-height: 1.5;">
        Clear name to deactivate cell. Rename to activate.
      </div>

      <div class="edit-modal-buttons">
        <button class="edit-modal-btn" id="editModalCancel">CANCEL</button>
        <button class="edit-modal-btn primary" id="editModalSave">DONE</button>
      </div>
    </div>
  </div>

  <!-- CELL EDIT MODAL -->
  <div class="edit-cell-modal" id="editCellModal">
    <div class="edit-cell-modal-content">
      <div class="edit-cell-modal-label" id="editCellLabel">CELL 01</div>
      <input type="text" class="edit-cell-modal-input" id="editCellInput" maxlength="20" autocomplete="off">
      <div class="edit-cell-modal-buttons">
        <button class="edit-cell-modal-btn" id="editCellCancel">CANCEL</button>
        <button class="edit-cell-modal-btn primary" id="editCellSave">SAVE</button>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/TRCKNG-SSTM/service-worker.js').catch(() => {});
    }

    (function () {
      // ===== КОНФИГУРАЦИЯ =====
      // Порядок и список привычек (можешь менять порядок, добавлять, удалять)
      const habits = [
        "cell01",
        "cell02", 
        "cell03",
        "cell04",
        "cell05",
        "cell06",
        "cell07",
        "cell08",
        "cell09"
      ];

      let habitLabels = {}; // Будет загружаться из localStorage или дефолтов

      // Default labels для каждого пина
      const defaultLabelsPerPin = {
        0: { // PIN 01 - четыре актива (по углам/диагонали)
          "cell01": "Water",
          "cell02": "Coffee",
          "cell03": "",
          "cell04": "",
          "cell05": "",
          "cell06": "Walk",
          "cell07": "Read",
          "cell08": "",
          "cell09": ""
        },
        1: { // PIN 02 - центр (один актив)
          "cell01": "",
          "cell02": "",
          "cell03": "",
          "cell04": "Focus",
          "cell05": "",
          "cell06": "",
          "cell07": "",
          "cell08": "",
          "cell09": ""
        },
        2: { // PIN 03 - все пусто
          "cell01": "",
          "cell02": "",
          "cell03": "",
          "cell04": "",
          "cell05": "",
          "cell06": "",
          "cell07": "",
          "cell08": "",
          "cell09": ""
        }
      };

      const STORAGE_KEY = "trckng_sstm_data";
      const WEEKS_TO_KEEP = 52; // 1 год
      const LABELS_KEY = "trckng_sstm_labels"; // Для сохранения переименованных названий
      let currentPin = 0; // Текущий активный пин (0, 1, или 2)

      let currentWeekKey = getWeekKey();
      let data = loadData();
      let decreaseMode = false;

      // Загружаем пользовательские имена привычек
      function loadCustomLabels() {
        // Сначала загружаем дефолты для текущего пина
        habitLabels = { ...defaultLabelsPerPin[currentPin] };
        
        // Потом перезаписываем загруженными из localStorage
        const key = `${LABELS_KEY}_pin${currentPin}`;
        const stored = localStorage.getItem(key);
        if (stored) {
          try {
            const custom = JSON.parse(stored);
            Object.assign(habitLabels, custom);
          } catch (e) {}
        }
      }

      // Сохраняем пользовательские имена
      function saveCustomLabels() {
        const key = `${LABELS_KEY}_pin${currentPin}`;
        const customLabels = {};
        habits.forEach(habit => {
          customLabels[habit] = habitLabels[habit];
        });
        localStorage.setItem(key, JSON.stringify(customLabels));
      }

      loadCustomLabels();

      // ===== НЕДЕЛЯ (First Monday rule) =====
      function firstMondayOfYear(year) {
        const jan1 = new Date(year, 0, 1);
        const dayOfWeek = jan1.getDay();
        const daysUntilMonday = (1 - dayOfWeek + 7) % 7;
        return new Date(year, 0, 1 + daysUntilMonday);
      }

      function getWeekKey(date = new Date()) {
        const y = date.getFullYear();
        const firstMonday = firstMondayOfYear(y);

        let weekYear = y;
        let weekNum = 1;

        if (date < firstMonday) {
          weekYear = y - 1;
          const firstMondayPrev = firstMondayOfYear(y - 1);
          const diffMs = date - firstMondayPrev;
          weekNum = 1 + Math.floor(diffMs / (7 * 24 * 60 * 60 * 1000));
        } else {
          const diffMs = date - firstMonday;
          weekNum = 1 + Math.floor(diffMs / (7 * 24 * 60 * 60 * 1000));
        }

        return `${weekYear}W${String(weekNum).padStart(2, "0")}`;
      }

      function getWeekDateRange(weekKey) {
        const [yearStr, weekStr] = weekKey.split("W");
        const year = parseInt(yearStr);
        const week = parseInt(weekStr);
        const fm = firstMondayOfYear(year);
        const startDate = new Date(fm);
        startDate.setDate(fm.getDate() + (week - 1) * 7);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        return { start: startDate, end: endDate };
      }

      function formatDateRange(start, end) {
        const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        const startStr = `${start.getDate()} ${months[start.getMonth()]}`;
        const endStr = `${end.getDate()} ${months[end.getMonth()]} ${end.getFullYear()}`;
        return `${startStr} - ${endStr}`;
      }

      // ===== ДАННЫЕ =====
      function loadData() {
        const storageKey = `${STORAGE_KEY}_pin${currentPin}`;
        const stored = localStorage.getItem(storageKey);
        return stored ? JSON.parse(stored) : {};
      }

      function saveData() {
        const storageKey = `${STORAGE_KEY}_pin${currentPin}`;
        const keys = Object.keys(data).sort().reverse();
        if (keys.length > WEEKS_TO_KEEP) {
          keys.slice(WEEKS_TO_KEEP).forEach(k => delete data[k]);
        }
        localStorage.setItem(storageKey, JSON.stringify(data));
      }

      function ensureWeekExists() {
        if (!data[currentWeekKey]) {
          data[currentWeekKey] = {};
        }
        // Инициализируем только те привычки которые есть в конфиге
        habits.forEach(h => {
          if (data[currentWeekKey][h] === undefined) {
            data[currentWeekKey][h] = 0;
          }
        });
        saveData();
      }

      // ===== ПРИВЫЧКИ =====
      function incrementHabit(habitName) {
        // Проверяем что ячейка активна (имеет имя)
        const label = habitLabels[habitName];
        if (!label || label.trim() === "") return;
        
        ensureWeekExists();
        if (decreaseMode) {
          data[currentWeekKey][habitName] = Math.max(0, (data[currentWeekKey][habitName] || 0) - 1);
        } else {
          data[currentWeekKey][habitName] = (data[currentWeekKey][habitName] || 0) + 1;
        }
        saveData();
        updateUI();

        // Анимация кнопки с градиентом
        const btn = document.getElementById(`btn-${habitName}`);
        if (btn) {
          animateButton(btn, habitName);
        }
      }

      // ===== ГЕНЕРАЦИЯ ЦВЕТОВОЙ ПАЛИТРЫ =====
      function generateColorPalette() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const timeValue = hours * 60 + minutes; // 0-1439
        
        // Базовый hue на основе времени (0-360)
        const baseHue = (timeValue / 1440) * 360;
        
        // Три цвета для кнопок - гармоничная композиция
        const button1Hue = baseHue;
        const button2Hue = (baseHue + 60) % 360; // Аналогичный
        const button3Hue = (baseHue + 240) % 360; // Трёхцветие
        
        const buttonColors = [
          `hsl(${button1Hue}, 100%, 50%)`,
          `hsl(${button2Hue}, 100%, 50%)`,
          `hsl(${button3Hue}, 100%, 50%)`
        ];
        
        // Применяем цвета к CSS переменным
        document.documentElement.style.setProperty('--palette-1', buttonColors[0]);
        document.documentElement.style.setProperty('--palette-2', buttonColors[1]);
        document.documentElement.style.setProperty('--palette-3', buttonColors[2]);
        
        return {
          buttonColors,
          baseHue
        };
      }

      // Генерируем палитру при загрузке
      const palette = generateColorPalette();
      let paletteIndex = 0;

      function animateButton(btn, habitName) {
        // Генерируем новый цвет из палитры
        let newColor;
        if (decreaseMode) {
          newColor = '#ff4f6a'; // Red для DECREASE
        } else {
          // Циклим через три цвета палитры
          newColor = palette.buttonColors[paletteIndex % 3];
          paletteIndex++;
          
          // Иногда добавляем вариацию в lightness для интереса
          if (Math.random() > 0.7) {
            // Извлекаем hue из текущего цвета и добавляем вариацию
            const hueMatch = newColor.match(/\d+/);
            const hue = hueMatch ? parseInt(hueMatch[0]) : 0;
            const lightness = 45 + Math.random() * 10; // 45-55%
            newColor = `hsl(${hue}, 100%, ${lightness}%)`;
          }
        }

        console.log(`Clicked ${habitName}, color: ${newColor}`);

        // Убираем выделение (важно для мобильных)
        btn.blur();

        // Применяем цвет и интенсивность
        btn.style.setProperty('--btn-color', newColor);
        btn.style.setProperty('--btn-intensity-attack', '1');

        // Добавляем класс анимации
        btn.classList.add('animating');

        // Убираем класс после завершения анимации
        setTimeout(() => {
          btn.classList.remove('animating');
          btn.style.setProperty('--btn-intensity-attack', '0');
        }, 800);
      }

      function updateUI() {
        ensureWeekExists();
        const weekData = data[currentWeekKey];

        habits.forEach(h => {
          const count = weekData[h] || 0;
          const countEl = document.getElementById(`count-${h}`);
          if (countEl) countEl.textContent = count;
        });

        const weekEl = document.getElementById("weekDisplay");
        const dateEl = document.getElementById("dateDisplay");
        if (weekEl) weekEl.textContent = currentWeekKey;
        if (dateEl) {
          const range = getWeekDateRange(currentWeekKey);
          dateEl.textContent = formatDateRange(range.start, range.end);
        }

        // Обновляем текущее время и дату
        updateHeaderTime();

        updateStats();
      }

      function updateHeaderTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        
        const timeEl = document.getElementById("headerTime");
        if (timeEl) {
          timeEl.textContent = `${hours}:${minutes}`;
        }

        const dayDateEl = document.getElementById("headerDayDate");
        if (dayDateEl) {
          const day = String(now.getDate()).padStart(2, "0");
          const monthName = now.toLocaleDateString('en-US', { month: 'short' });
          const dayName = now.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
          
          // Вычисляем процент недели (0-100%)
          const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday...
          const minutesInDay = now.getHours() * 60 + now.getMinutes();
          const minutesInWeek = ((dayOfWeek === 0 ? 6 : dayOfWeek - 1) * 24 * 60) + minutesInDay;
          const weekProgress = Math.round((minutesInWeek / (7 * 24 * 60)) * 100);
          
          dayDateEl.textContent = `${day} ${monthName}\n${dayName} · ${weekProgress}%`;
        }
      }

      function updateStats() {
        const statsEl = document.getElementById("stats");
        
        // Проверяем есть ли активные ячейки
        const hasActiveHabits = habits.some(habit => {
          const label = habitLabels[habit];
          return label && label.trim() !== "";
        });

        // Если нет активных ячеек - показываем пусто
        if (!hasActiveHabits) {
          statsEl.innerHTML = '<div style="padding: 16px; text-align: center; opacity: 0.5; font-size: 12px;">No data yet</div>';
          return;
        }

        const allWeeks = Object.keys(data).sort().reverse().slice(0, 3);

        if (allWeeks.length === 0) {
          statsEl.innerHTML = '<div style="padding: 16px; text-align: center; opacity: 0.5; font-size: 12px;">No data yet</div>';
          return;
        }

        let html = `
          <table class="stats-table">
            <thead>
              <tr>
                <th>Week</th>
        `;

        // Заголовки с названиями привычек
        habits.forEach((habit, idx) => {
          const label = habitLabels[habit];
          // Пропускаем неактивные ячейки
          if (!label || label.trim() === "") return;
          
          const cellNum = idx + 1;
          const cellLabel = `CELL ${String(cellNum).padStart(2, "0")}`;
          html += `<th data-habit="${habit}" data-cell="${cellLabel}">${label}</th>`;
        });
        html += `
              </tr>
            </thead>
            <tbody>
        `;

        // Строки с данными по неделям
        allWeeks.forEach(week => {
          const weekData = data[week];
          html += `<tr data-week="${week}"><td>${week}</td>`;
          
          habits.forEach((habit, idx) => {
            const label = habitLabels[habit];
            // Пропускаем неактивные ячейки
            if (!label || label.trim() === "") return;
            
            const count = weekData[habit] || 0;
            const cellNum = idx + 1;
            const cellLabel = `CELL ${String(cellNum).padStart(2, "0")}`;
            html += `<td data-habit="${habit}" data-cell="${cellLabel}">${count}</td>`;
          });
          
          html += `</tr>`;
        });

        html += `
            </tbody>
          </table>
        `;

        statsEl.innerHTML = html;
        attachTableHoverListeners();
      }

      const COLOR_CACHE_KEY = "trckng_color_cache";
      const COLOR_CACHE_TIME_KEY = "trckng_color_cache_time";
      const HIGHLIGHT_COLOR = "#ff8c42"; // Тёплый оранжевый для подсветки

      function attachTableHoverListeners() {
        const table = document.querySelector(".stats-table");
        if (!table) return; // Таблицы нет - выходим

        const cells = table.querySelectorAll("th, td");
        if (cells.length === 0) return; // Нет ячеек - выходим
        
        cells.forEach(cell => {
          // Удаляем старые слушатели, клонируя элемент
          const newCell = cell.cloneNode(true);
          cell.parentNode.replaceChild(newCell, cell);
        });

        // Добавляем слушатели на новые элементы
        const newCells = table.querySelectorAll("th, td");
        
        newCells.forEach(cell => {
          cell.addEventListener("mouseenter", function() {
            const habit = this.dataset.habit;
            const week = this.closest("tr")?.dataset.week;

            // Подсвечиваем всю строку (неделю)
            if (week) {
              const row = table.querySelector(`tr[data-week="${week}"]`);
              if (row) {
                row.style.backgroundColor = `color-mix(in srgb, ${HIGHLIGHT_COLOR} 10%, transparent)`;
              }
            }

            // Подсвечиваем весь столбец (привычка)
            if (habit) {
              const headerCell = table.querySelector(`thead th[data-habit="${habit}"]`);
              const bodyCells = table.querySelectorAll(`tbody td[data-habit="${habit}"]`);
              
              if (headerCell) {
                headerCell.style.color = HIGHLIGHT_COLOR;
                headerCell.style.backgroundColor = `color-mix(in srgb, ${HIGHLIGHT_COLOR} 15%, transparent)`;
              }
              bodyCells.forEach(cell => {
                if (cell !== this) {
                  cell.style.color = HIGHLIGHT_COLOR;
                  cell.style.backgroundColor = `color-mix(in srgb, ${HIGHLIGHT_COLOR} 10%, transparent)`;
                }
              });
            }

            // Подсвечиваем текущую ячейку
            this.style.color = HIGHLIGHT_COLOR;
            this.style.backgroundColor = `color-mix(in srgb, ${HIGHLIGHT_COLOR} 25%, transparent)`;
            this.style.fontWeight = "500";
          });

          cell.addEventListener("mouseleave", function() {
            // Убираем стили при уходе мыши
            this.style.color = "";
            this.style.backgroundColor = "";
            this.style.fontWeight = "";

            const habit = this.dataset.habit;
            const week = this.closest("tr")?.dataset.week;

            if (week) {
              const row = table.querySelector(`tr[data-week="${week}"]`);
              if (row) row.style.backgroundColor = "";
            }

            if (habit) {
              const headerCell = table.querySelector(`thead th[data-habit="${habit}"]`);
              const bodyCells = table.querySelectorAll(`tbody td[data-habit="${habit}"]`);
              
              if (headerCell) {
                headerCell.style.color = "";
                headerCell.style.backgroundColor = "";
              }
              bodyCells.forEach(cell => {
                cell.style.color = "";
                cell.style.backgroundColor = "";
              });
            }
          });
        });
      }

      function getPreviousWeekKey() {
        const now = new Date();
        const lastWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const jan4 = new Date(lastWeek.getFullYear(), 0, 4);
        const weekOne = new Date(jan4.getFullYear(), jan4.getMonth(), jan4.getDate() - jan4.getDay());
        const diff = lastWeek - weekOne;
        const weekNum = Math.floor(diff / (7 * 24 * 60 * 60 * 1000)) + 1;
        return `${lastWeek.getFullYear()}W${String(weekNum).padStart(2, "0")}`;
      }

      // ===== ЭКСПОРТ/ИМПОРТ =====
      function copyPreviousWeek() {
        const prevWeek = getPreviousWeekKey();
        const weekData = data[prevWeek] || {};
        
        let text = `${prevWeek}\n`;
        habits.forEach(habit => {
          const label = habitLabels[habit];
          // Пропускаем неактивные ячейки
          if (!label || label.trim() === "") return;
          
          const count = weekData[habit] || 0;
          text += `${label}: ${count}\n`;
        });

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(() => {
            alert("✓ Prev week copied");
          }).catch(() => {
            fallbackCopy(text);
          });
        } else {
          fallbackCopy(text);
        }
      }

      function exportAllData() {
        const exportText = JSON.stringify(data, null, 2);
        
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(exportText).then(() => {
            alert("✓ Full history copied");
          }).catch(() => {
            fallbackCopy(exportText);
          });
        } else {
          fallbackCopy(exportText);
        }
      }

      function fallbackCopy(text) {
        const temp = document.createElement("textarea");
        temp.value = text;
        temp.style.position = "fixed";
        temp.style.left = "-9999px";
        document.body.appendChild(temp);
        temp.select();
        try {
          document.execCommand("copy");
          alert("✓ Copied to clipboard");
        } catch (e) {
          alert("Failed to copy");
        }
        document.body.removeChild(temp);
      }

      function importData() {
        const fileInput = document.getElementById("fileInput");
        fileInput.click();
      }

      function resetAll() {
        if (!confirm("═══════════════════════════════\nDELETE ALL DATA?\n═══════════════════════════════\n\nThis will erase everything:\n- All tracking data\n- All pins and settings\n- Cannot be undone\n\nProceed?")) {
          return;
        }

        // Очищаем все для всех трёх пинов
        for (let pin = 0; pin < 3; pin++) {
          localStorage.removeItem(`${STORAGE_KEY}_pin${pin}`);
          localStorage.removeItem(`${LABELS_KEY}_pin${pin}`);
        }

        // Очищаем остальной кеш
        localStorage.removeItem('trckng_has_seen_info');
        localStorage.removeItem(COLOR_CACHE_KEY);
        localStorage.removeItem(COLOR_CACHE_TIME_KEY);

        // Сообщение об успехе
        alert("✓ All data deleted\nRefreshing app...");
        
        // Перезагружаем страницу
        window.location.reload();
      }

      document.getElementById("fileInput").addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const imported = JSON.parse(event.target.result);
            // Мигрируем данные: если счётчика нет в новой конфиге, он всё равно сохраняется
            Object.assign(data, imported);
            saveData();
            updateUI();
            alert("✓ Data imported");
          } catch (err) {
            alert("✗ Import failed");
          }
        };
        reader.readAsText(file);
      });

      function toggleDecrease() {
        decreaseMode = !decreaseMode;
        const btn = document.getElementById("btnDecrease");
        const grid = document.getElementById("habitsGrid");
        
        if (decreaseMode) {
          btn.classList.add("active");
          grid.classList.add("decrease-mode");
          // Добавляем класс всем кнопкам привычек
          habits.forEach(h => {
            const btn = document.getElementById(`btn-${h}`);
            if (btn) btn.classList.add("decrease-mode");
          });
        } else {
          btn.classList.remove("active");
          grid.classList.remove("decrease-mode");
          habits.forEach(h => {
            const btn = document.getElementById(`btn-${h}`);
            if (btn) btn.classList.remove("decrease-mode");
          });
        }
      }

      // ===== ИНТЕРФЕЙС =====
      function renderHabits() {
        const grid = document.getElementById("habitsGrid");
        grid.innerHTML = "";
        
        habits.forEach((habit, idx) => {
          const label = habitLabels[habit];
          const isActive = label && label.trim() !== "";
          
          const button = document.createElement("button");
          button.className = "btn-habit";
          if (!isActive) {
            button.classList.add("inactive");
          }
          button.id = `btn-${habit}`;
          
          // Показываем текст только для активных
          if (isActive) {
            button.innerHTML = `
              <span class="btn-label">${label}</span>
              <span class="btn-count" id="count-${habit}">0</span>
            `;
          } else {
            // Неактивные - без содержимого
            button.innerHTML = '';
          }
          
          // Кликать можно только активные ячейки
          if (isActive) {
            button.addEventListener("click", () => incrementHabit(habit));
          } else {
            button.style.cursor = "default";
            button.style.pointerEvents = "none";
          }
          
          grid.appendChild(button);
        });
      }

      function openEditModal() {
        const modal = document.getElementById("editModal");
        const container = document.getElementById("editItemsContainer");
        
        container.innerHTML = "";
        habits.forEach((habit, index) => {
          const cellNum = index + 1;
          const cellLabel = `CELL ${String(cellNum).padStart(2, "0")}`;
          
          const item = document.createElement("button");
          item.className = "edit-item";
          item.type = "button";
          const displayName = habitLabels[habit] || ""; // Показываем пусто как пусто
          item.innerHTML = `
            <div class="edit-item-label">${cellLabel}</div>
            <div class="edit-item-name">${displayName === "" ? "—" : displayName}</div>
          `;
          item.addEventListener("click", () => openCellEditModal(habit, cellLabel, index));
          container.appendChild(item);
        });

        modal.classList.add("visible");
      }

      function closeEditModal() {
        const modal = document.getElementById("editModal");
        modal.classList.remove("visible");
      }

      function openCellEditModal(habit, cellLabel, index) {
        const modal = document.getElementById("editCellModal");
        const label = document.getElementById("editCellLabel");
        const input = document.getElementById("editCellInput");
        
        label.textContent = cellLabel;
        input.value = habitLabels[habit] || habit;
        input.dataset.habit = habit;
        
        modal.classList.add("visible");
        setTimeout(() => input.focus(), 100);
      }

      function closeCellEditModal() {
        const modal = document.getElementById("editCellModal");
        modal.classList.remove("visible");
      }

      function saveCellEdit() {
        const input = document.getElementById("editCellInput");
        const habit = input.dataset.habit;
        const newLabel = input.value.trim();
        
        // Если имя было и стало пусто — обнуляем счётчик
        const wasActive = habitLabels[habit] && habitLabels[habit].trim() !== "";
        const isNowEmpty = newLabel === "";
        
        if (wasActive && isNowEmpty) {
          // Обнуляем все значения этой ячейки во всех неделях
          Object.keys(data).forEach(week => {
            data[week][habit] = 0;
          });
        }
        
        // Сохраняем новое имя (может быть пустым)
        habitLabels[habit] = newLabel;
        saveCustomLabels();
        saveData();
        
        // Обновляем UI
        renderHabits();
        updateUI();
        openEditModal();
        
        closeCellEditModal();
      }

      // ===== СОБЫТИЯ =====
      // Пины
      document.querySelectorAll(".pin").forEach(pin => {
        pin.addEventListener("click", function() {
          const pinNum = parseInt(this.dataset.pin);
          switchPin(pinNum);
        });
      });

      // Контролы
      document.getElementById("btnCopyPrev").addEventListener("click", copyPreviousWeek);
      document.getElementById("btnExport").addEventListener("click", exportAllData);
      document.getElementById("btnImport").addEventListener("click", importData);
      document.getElementById("btnReset").addEventListener("click", resetAll);
      document.getElementById("btnDecrease").addEventListener("click", toggleDecrease);
      document.getElementById("btnEdit").addEventListener("click", openEditModal);
      document.getElementById("btnInfo").addEventListener("click", openInfo);

      // Main modal события
      document.getElementById("editModalCancel").addEventListener("click", closeEditModal);
      document.getElementById("editModalSave").addEventListener("click", closeEditModal);
      document.getElementById("editModal").addEventListener("click", function(e) {
        if (e.target === this) closeEditModal();
      });

      // Cell edit modal события
      document.getElementById("editCellCancel").addEventListener("click", closeCellEditModal);
      document.getElementById("editCellSave").addEventListener("click", saveCellEdit);
      document.getElementById("editCellModal").addEventListener("click", function(e) {
        if (e.target === this) closeCellEditModal();
      });

      // Splash & Info
      const splash = document.getElementById("splash");
      const btnStart = document.getElementById("btnStartApp");
      const btnInfoClose = document.getElementById("btnInfoClose");
      const infoModal = document.getElementById("infoModal");
      const btnInfo = document.getElementById("btnInfo");

      // Пульсирующий ? при первом открытии
      const hasSeenInfo = localStorage.getItem("trckng_has_seen_info");
      if (!hasSeenInfo && btnInfo) {
        btnInfo.classList.add("pulse");
        // Снимаем пульсацию при клике
        btnInfo.addEventListener("click", function() {
          btnInfo.classList.remove("pulse");
          localStorage.setItem("trckng_has_seen_info", "true");
        });
      }

      if (btnStart) {
        btnStart.addEventListener("click", hideSplash);
      }

      if (btnInfoClose) {
        btnInfoClose.addEventListener("click", closeInfo);
      }

      if (infoModal) {
        infoModal.addEventListener("click", function(e) {
          if (e.target === this) closeInfo();
        });
      }

      // Закрытие на Escape
      document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
          const cellModal = document.getElementById("editCellModal");
          const mainModal = document.getElementById("editModal");
          const infoMod = document.getElementById("infoModal");
          if (cellModal?.classList.contains("visible")) {
            closeCellEditModal();
          } else if (mainModal?.classList.contains("visible")) {
            closeEditModal();
          } else if (infoMod?.classList.contains("visible")) {
            closeInfo();
          }
        }
      });

      function showSplash() {
        const splash = document.getElementById("splash");
        if (splash) splash.classList.remove("hidden");
      }

      function hideSplash() {
        const splash = document.getElementById("splash");
        if (splash) splash.classList.add("hidden");
      }

      function openInfo() {
        const modal = document.getElementById("infoModal");
        if (modal) modal.classList.add("visible");
      }

      function closeInfo() {
        const modal = document.getElementById("infoModal");
        if (modal) modal.classList.remove("visible");
      }

      function switchPin(pinNum) {
        currentPin = pinNum;
        
        // Обновляем активный пин в UI
        document.querySelectorAll(".pin").forEach(pin => {
          pin.classList.remove("active");
        });
        document.getElementById(`pin${pinNum}`).classList.add("active");

        // Перезагружаем данные для нового пина
        data = loadData();
        
        // Перезагружаем labels для нового пина (с дефолтами)
        loadCustomLabels();
        
        currentWeekKey = getWeekKey();
        ensureWeekExists();
        
        // Обновляем UI
        renderHabits();
        updateUI();
      }

      // ===== ИНИЦИАЛИЗАЦИЯ =====
      renderHabits();
      ensureWeekExists();
      updateUI();

      // Обновляем время каждую минуту
      setInterval(() => {
        updateHeaderTime();
      }, 60000); // 60000 мс = 1 минута

      // Проверка на понедельник (напоминание об экспорте)
      const now = new Date();
      if (now.getDay() === 1) { // 1 = понедельник
        setTimeout(() => {
          if (Notification.permission === "granted") {
            new Notification("TRCKNG SSTM", {
              body: "Time to export last week to Obsidian",
              icon: "/TRCKNG-SSTM/icons/icon-192.png"
            });
          }
        }, 2000);
      }

      // Запрос прав на уведомления
      if ('Notification' in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    })();
  </script>

</body>
</html>
